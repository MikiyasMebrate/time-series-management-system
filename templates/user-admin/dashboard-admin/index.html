{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">

  <!-- [Head] start -->

  <head>
    <title>Home | MoPD Dashboard </title>
    <meta charset="utf-8" />
    <meta name="viewport"
      content="width=device-width,initial-scale=1,user-scalable=0,minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="description"
      content="Able Pro is trending dashboard template made using Bootstrap 5 design framework. Able Pro is available in Bootstrap, React, CodeIgniter, Angular,  and .net Technologies." />
    <meta name="keywords"
      content="Bootstrap admin template, Dashboard UI Kit, Dashboard Template, Backend Panel, react dashboard, angular dashboard" />
    <meta name="author" content="Phoenixcoded" />
    <link rel="stylesheet"
      href="https://code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">
    <script
      src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag/dist/js/multi-select-tag.js"></script>
    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag/dist/css/multi-select-tag.css" />
    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jquery-toast-plugin@1.3.2/dist/jquery.toast.min.css">

    {% include 'dashboard/include/head.html' %}
  </head>
  <!-- [Head] end -->
  <style>
    .pc-content {
        min-height: 100vh;
    }

    .pc-content img {
        width: 500px;
    }
</style>

  <body data-pc-preset="preset-1" data-pc-sidebar-caption="true"
    data-pc-layout="vertical" data-pc-direction="ltr"
    data-pc-theme_contrast data-pc-theme="light">

    <!-- [ Pre-loader ] start -->
    <div class="loader-bg">
      <div class="loader-track">
        <div class="loader-fill"></div>
      </div>
    </div>
    <!-- [ Pre-loader ] End -->

    <!-- [ Sidebar Menu ] start -->
    <nav class="pc-sidebar">
      <div class="navbar-wrapper">
        <div class="text-center">
          <h3 class="bg-primary text-light p-3">{{dashboard.title | capfirst}}</h3>
        </div>
        <div class="navbar-content">

          <ul class="pc-navbar">

            <li class="pc-item  pc-caption">
              <label>Dashboards</label>
              <svg class="pc-icon">
                <use xlink:href="#custom-presentation-chart"></use>
              </svg>
            </li>

            <li class="pc-item pc-hasmenu active pc-trigger">

              <a href="#" class="pc-link">
                <span class="pc-micon">
                  <svg class="pc-icon"><use
                      xlink:href="#custom-status-up"></use></svg>
                </span>
                <span class="pc-mtext">Row</span>

                <span class="pc-arrow">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-chevron-right">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </span>
              </a>

              <ul class="pc-submenu"
                style="display: block; box-sizing: border-box;">

                <li class="pc-item active">
                  <a name="row" class="pc-link border" href="#">Full Width</a>
                </li>

              </ul>

            </li>

            <li class="pc-item pc-hasmenu close pc-trigger">

              <a href="#" class="pc-link">
                <span class="pc-micon">
                  <svg class="pc-icon">
                    <use xlink:href="#custom-status-up"></use>
                  </svg>
                </span>
                <span class="pc-mtext">Charts</span>

                <span class="pc-arrow">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-chevron-right">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </span>
              </a>

              <ul class="pc-submenu"
                style="display: block; box-sizing: border-box;">

                {% for component in components%}
                <li class="pc-item active">
                  <a class="pc-link" href="#">{{component.name}}</a>
                  <div
                    name="component"
                    data-id="{{component.id}}"
                    data-is-multiple="{{component.is_multiple}}"
                    data-is-range="{{component.is_range}}"
                    data-is-single-year="{{component.is_single_year}}"
                    data-has-title="{{component.has_title}}"
                    data-has-description="{{component.has_description}}"
                    data-has-indicator="{{component.has_indicator}}"
                    class="text-center">
                    <img src="/media/{{component.image}}" style="width: 150px;"
                      class="img-fluid" alt>
                  </div>
                </li>
                {% endfor %}

              </ul>

            </li>

          </ul>

        </div>

      </div>
    </nav>
    <!-- [ Sidebar Menu ] end -->

    {% include 'dashboard/include/header.html' %}

    <div class="pc-container">

      <!-- [ Main Content ] start -->
      <div class="pc-content">
        <div id="droppable2" name="drop-element" style="height:100vh;"  class="ui-droppable">

          <!-- Start Editable components-->
          {% for row in rows%}
          <div name="row" id="{{row.id}}" class="row p-5 bg-gray-300 border mt-1 rounded-3 ui-droppable ui-sortable ui-draggable ui-draggable-handle">

            <div class="d-flex align-items-center justify-content-between mb-3">
              <small class="mb-0">rank - {{row.rank}}</small>
              <div class="dropdown">
                  <a class="avtar avtar-s btn-link-secondary dropdown-toggle arrow-none" href="#" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="ti ti-dots-vertical f-18"></i>
                  </a>
                  <div class="dropdown-menu dropdown-menu-end">
                    <button 
                      class="dropdown-item" 
                      name="btn-rank-row" 
                      data-bs-toggle="modal" 
                      data-bs-target="#modalRowRank"
                      data-row-id="${rowId}"
                      data-row-rank=${rank}
                      >Edit row
                    </button>
                    <button 
                      class="dropdown-item text-danger" 
                      name="btn-delete-row" 
                      data-bs-toggle="modal" 
                      data-bs-target="#removeRow"
                      data-row-id="{{row.id}}"
                      >Delete
                    </button>
                  </div>
              </div>
            </div>
            
            {% for col in row.cols.all%}
            <div name="col_component" id="dragged_col_{{col.id}}" class="col-md-{% if col.width == '100%' %}12{% elif col.width == '50%' %}6{% elif col.width == '33%' %}4{% elif col.width == '25%' %}3{% else %}12{% endif %} col-md-4 row-col ui-sortable-handle">
            
              <div class="card">
                <div class="card-body">
                  <!--card header-->
                  <div class="d-flex align-items-center">

                    <!--Indicator Title-->
                    <div class="flex-grow-1 ms-3">
                      <p class="mb-0"></p>
                    </div>

                    <!--Detail Button-->
                    <div class="flex-shrink-0 ms-3">
                      <div class="dropdown">
                        <a class="avtar avtar-s btn-link-primary dropdown-toggle arrow-none"
                          href="#" data-bs-toggle="dropdown"
                          aria-haspopup="true" aria-expanded="false">
                          <i class="ti ti-dots-vertical f-18"></i>
                        </a>
                      
                        <div class="dropdown-menu dropdown-menu-end">
                          <!--Col edit button-->
                          <button 
                            type="button" 
                            name="btn-edit" 
                            id="col_{{col.id}}"
                            data-id="{{col.component.id}}"
                            data-is-multiple="{{col.component.is_multiple}}" 
                            data-is-single-year="{{col.component.is_single_year}}"
                            data-is-range="{{col.component.is_range}}" 
                            data-row-id="{{row.id}}"
                            data-has-title="{{col.component.has_title}}" 
                            data-has-indicator="{{col.component.has_indicator}}"
                            data-has-description="{{col.component.has_description}}" 
                            data-col-id="{{col.id}}"
                            data-col-indicator-id="{{ col.indicator.all|get_ids }}"
                            data-col-width="{{col.width}}"
                            data-col-title="{{col.title}}"
                            data-col-description="{{col.description}}"
                            data-col-data-range-start="{{col.data_range_start.id}}"
                            data-col-data-range-end="{{col.data_range_end.id}}"
                            data-bs-toggle="modal"
                            data-bs-target="#modalAddDashboardRow"
                            class="dropdown-item">
                            <svg class="pc-icon"> <use
                                xlink:href="#custom-flash"></use></svg>
                            Edit
                          </button>

                            <!--Col Delete  Button-->
                          <button 
                            type="button" 
                            name="btn-delete"
                            data-col-id="{{col.id}}" 
                            data-is-created="True"
                            data-bs-toggle="modal" 
                            data-bs-target="#removeComponent"
                            class="dropdown-item">
                            <i class="text-danger ti ti-x f-20 "></i>
                            <span class="text-danger">Delete</span>
                          </button>
                        </div>

                        
                      </div>
                    </div>
                  </div>

                  <div 
                    name="component" 
                    data-id="{{col.component.id}}" 
                    data-is-multiple="{{col.component.is_multiple}}"
                    data-is-range="{{col.component.is_range}}" 
                    data-is-single-year="{{col.component.is_single_year}}"
                    data-has-title="{{col.component.has_title}}" 
                    data-has-description="{{col.component.has_description}}"
                    data-has-indicator="{{col.component.has_indicator}}"
                    class="text-center ui-draggable ui-draggable-handle">
                    <img
                      src="/media/{{col.component.image}}"
                      style="width: 100%;" class="img-fluid" alt>
                  </div>

                </div>
              </div>
            </div>
            {% endfor %}

          </div>
          {% endfor %} 
          <!--end Editable components-->

          
        </div>
      </div>

        <!--Modal Add Dashboard Row-->
        <div class="modal fade" id="modalAddDashboardRow" tabindex="-1"
          aria-labelledby="modalAddDashboardRowLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalAddDashboardRowLabel">Add
                  Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </div>
              <form id="form-configuration" method="post">
                <div class="modal-body">
                  <input id="form_col_id" type="hidden" value name="col-id">
                  {{form.as_p}}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save
                    changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Modal Delete Col -->
        <div class="modal fade" id="removeComponent" tabindex="-1" aria-labelledby="removeComponentLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="removeComponentLabel">Delete Row</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="delete_modal" method="post">
                <div class="modal-body">
                  <input id="delete_input_col_id" type="hidden">
                  <input id="delete_input_id_created" type="hidden">
                 Are you sure you want to remove this component?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-danger">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>

         <!-- Modal Delete row -->
         <div class="modal fade" id="removeRow" tabindex="-1" aria-labelledby="removeRowLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="removeRowLabel">Delete Row</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="delete-row-modal" method="post">
                <div class="modal-body">
                  <input id="delete_row_id" type="hidden">
                  Are you sure you want to remove this row? Deleting it may impact any columns contained within.
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-danger">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>

         <!-- Modal row rank -->
         <div class="modal fade" id="modalRowRank" tabindex="-1" aria-labelledby="modalRowRankLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalRowRankLabel">Rank Row</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="delete-row-modal" method="post">
                <div class="modal-body">
                  <p>Are you sure you want to modify the ranking of this row? This may impact the current order.</p>
                  <label class="form-label" for="row_rank_input">Input rank:</label>
                  <input type="number" class="form-control" id="row_rank_input">
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>



        {% include 'dashboard/include/js.html'%}

        <script
          src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
          integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script
          src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.14.0/jquery-ui.min.js"
          integrity="sha512-MlEyuwT6VkRXExjj8CdBKNgd+e2H+aYZOCUaCrt9KRk6MlZDOs91V1yK22rwm8aCIsb5Ec1euL8f0g58RKT/Pg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script
          src="https://cdn.jsdelivr.net/npm/jquery-toast-plugin@1.3.2/dist/jquery.toast.min.js"></script>

        <script type="text/javascript">
         const showToast = (title, body, cssClass) => {
               $.toast({
                heading: title,
                text: body,
                showHideTransition: 'slide',
                icon: cssClass,
                position: 'top-right',
              })
            }
         
        //handle backend row created
        const handleRowCreated = async () => {
        try {
          let id = await new Promise((resolve, reject) => {
            $.ajax({
              type: 'POST',
              url: `{% url "custom-dashboard-topic" dashboard.id %}`,
              data: {
                'rank': 1,
                csrfmiddlewaretoken: '{{csrf_token}}'
              },
              success: function (response) {
                if (response.success) {
                  resolve([response.row, response.rank]);  // Resolve with the row ID
                } else {
                  reject("Error: Failed to get ID");
                }
              },
              error: function () {
                reject("Error: AJAX request failed");
              }
            });
          });
      
          return id;  // Return the ID after successful AJAX call
      
        } catch (error) {
          console.error(error);  // Log the error if something goes wrong
          return null;  // Return null in case of an error
        }
    };


         //handle on modal col[component] submit
         $("#form-configuration").on('submit', (e)=>{
            e.preventDefault();   

            let colId = $("#form_col_id").val();  // Get the column ID
            console.log('col-id',colId)

            let isMultiple = $(`#${colId}`).data('isMultiple')
            let isRange =$(`#${colId}`).data('isRange');
            let componentId = $(`#${colId}`).data('id');
            
            let rowId = $(`#${colId}`).data('rowId') || null;

            let indicator = $("#id_indicator").val();
            indicator = isMultiple ? indicator : [indicator]

            let title = $("#id_title").val()
            let description = $("#id_description").val()
            let year = $("#id_year").val();
            let data_range_start = $("#id_data_range_start").val();
            let data_range_end = $("#id_data_range_end").val();

            let width = $("#id_width").val();    

            let colSize = width == '25%' ? 'col-md-3' : (width == '33%' ? 'col-md-4' : (width == '50%' ? 'col-md-6' : (width == '100%' ? 'col-md-12' : '')));
            console.log(colId, "aftttttt")
            try{
              document.getElementById(`dragged_${colId}`).className = colSize;
            }catch{
              document.getElementById(`dragged_${colId}`).className = colSize;
            }
            
            $.ajax({
              type: 'POST',
              url: `{% url "custom-dashboard-topic" dashboard.id %}`,
              data: {
                'dashboardId' : $(`#${colId}`).data('col-id') ? $(`#${colId}`).data('col-id') : null,
                'isMultiple': isMultiple,
                'isRange' : isRange,
                'title' : title || null,
                'description' : description || null,
                'componentId' : componentId,
                'indicator' : indicator,
                'year' : year,
                'data_range_start' : data_range_start || null,
                'data_range_end' : data_range_end || null,
                'rowId' : rowId,
                'width' : width,
                csrfmiddlewaretoken: '{{csrf_token}}'
              },

              success: function (response) {
                if (response.success) {

                  //assign real data to col
                  $(`#${colId}`).data('col-id', response.id) 
                  $(`#${colId}`).data('col-indicator-id', indicator) 
                  $(`#${colId}`).data('col-year-id', year) 
                  $(`#${colId}`).data('col-width', width)
                  $(`#${colId}`).data('col-title', title)
                  $(`#${colId}`).data('col-description', description)
                  $(`#${colId}`).data('col-data-range-start', data_range_start) 
                  $(`#${colId}`).data('col-data-range-end', data_range_end)


                  try{
                    //for update button
                    $(`#${colId}`).attr("id", `col_${response.id}`);

                    //for delete button
                    //update delete button data to component created true
                    $(`#delete_btn_${colId}`).attr("data-is-created", "True");

                    //update data of col-id
                    $(`#delete_btn_${colId}`).attr("data-col-id", response.id);
                     //update id of col 
                     $(`#dragged_${colId}`).attr("id", `dragged_col_${response.id}`);

                    
                  }catch{
                    console.log("ID Updated failed!")
                  }
                 
                   //show succuss message
                   showToast('&#128515 Hello, User', 'Successfully component created', 'success')
                   $('#modalAddDashboardRow').modal('hide'); //Hide Modal


                } else {
                    console.error('here eeeee err here')
                }
              },
              error: function (err) {
                console.log(err)
              }
            });
          })

        
        //handle on col-delete 
        $("#delete_modal").on('submit', async function(e){
        e.preventDefault()

        const colID = $("#delete_input_col_id").val()
        const isCreated = $(`#delete_input_id_created`).val() == 'True' ? true : false

        if(isCreated){
          $.ajax({
            type: 'DELETE',
            url: `{% url "custom-dashboard-topic" dashboard.id %}`,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'  // add CSRF token to headers
            },
            data: JSON.stringify({ 'id': colID, 'isCol' : true}),
            success: function (response) {
                if (response.success) {
                     //show succuss message
                     showToast('&#128515 Hello, User', 'Successfully component removed', 'success')
                     console.log(`#dragged_col_${colID}`)
                    $(`#dragged_col_${colID}`).remove() //remove from html
                    $('#removeComponent').modal('hide'); //Hide Modal

                } else {
                    // Show error message
                    showToast('&#128577; Oops!', 'Failed to remove the component', 'error');
                }
            },
            error: function () {
                // Show error message
                showToast('&#128577; Oops!', 'Failed to remove the component', 'error');
            }
          });
        }else{
            //show succuss message
            showToast('&#128515 Hello, User', 'Successfully component removed', 'success')
            
            $(`#dragged_col_${colID}`).remove() //remove from html
            $('#removeComponent').modal('hide'); //Hide Modal
        }
    })

    //handle on row-delete 
    $("#delete-row-modal").on('submit', async function(e){
        e.preventDefault()

        const rowID = $("#delete_row_id").val()

        $.ajax({
          type: 'DELETE',
          url: `{% url "custom-dashboard-topic" dashboard.id %}`,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'  // add CSRF token to headers
          },
          data: JSON.stringify({ 'id': rowID, 'isRow' : true }),
          success: function (response) {
              if (response.success) {
                   //show succuss message
                   showToast('&#128515 Hello, User', 'Successfully row removed', 'success')
                  $(`#${rowID}`).remove() //remove from html
                  $('#removeRow').modal('hide'); //Hide Modal
              } else {
                  // Show error message
                  showToast('&#128577; Oops!', 'Failed to remove the row', 'error');
              }
          },
          error: function () {
              // Show error message
              showToast('&#128577; Oops!', 'Failed to remove the row', 'error');
          }
        });
    })
    
    </script>

        <script
          src="{% static 'dashboard/assets/js/custom/dashboard-admin.js' %}"></script>

      </body>

    </html>